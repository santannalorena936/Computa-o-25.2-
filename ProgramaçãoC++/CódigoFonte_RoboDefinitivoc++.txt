#include <Servo.h>

// ============================
// Servos
// ============================
Servo servoBase;
Servo servoOmbro;
Servo servoCotovelo;
Servo servoGarra;

// ============================
// PosiÃ§Ãµes
// ============================
int posBase = 90;
int posOmbro = 90;
int posCotovelo = 90;
int posGarra = 90;

// ============================
// Motor do rolo
// ============================
int IN1 = 10;
int IN2 = 11;
int ENA = 12;

// ============================
// Sensor ultrassÃ´nico
// ============================
int trigPin = 7;
int echoPin = 8;
const int distanciaMin = 15;

// ============================
// LED e buzzer
// ============================
int ledAlerta = 4;
int buzzer = 2;

// ============================
// MediÃ§Ã£o de distÃ¢ncia
// ============================
long medirDistancia() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duracao = pulseIn(echoPin, HIGH, 30000);
  return duracao * 0.034 / 2;
}

// ============================
// Setup
// ============================
void setup() {

  Serial.begin(9600);

  servoBase.attach(3);
  servoOmbro.attach(5);
  servoCotovelo.attach(6);
  servoGarra.attach(9);

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(ENA, OUTPUT);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(ledAlerta, OUTPUT);
  pinMode(buzzer, OUTPUT);

  servoBase.write(posBase);
  servoOmbro.write(posOmbro);
  servoCotovelo.write(posCotovelo);
  servoGarra.write(posGarra);

  Serial.println("Sistema robÃ³tico iniciado com seguranÃ§a ativa.");
}

// ============================
// Loop principal
// ============================
void loop() {

  long distancia = medirDistancia();

  // ðŸ“Š LOG DE DADOS
  Serial.print("Distancia: ");
  Serial.print(distancia);
  Serial.println(" cm");

  // ============================
  // OBSTÃCULO DETECTADO
  // ============================
  if (distancia > 0 && distancia < distanciaMin) {

    // ðŸ”´ Alerta visual
    digitalWrite(ledAlerta, HIGH);

    // ðŸ”Š Alerta sonoro
    tone(buzzer, 1000);

    // â›” Para o rolo
    digitalWrite(IN1, LOW);
    digitalWrite(IN2, LOW);


    Serial.println("ALERTA: ObstÃ¡culo detectado!");

    delay(200);
    return;
  }

  // ============================
  // SituaÃ§Ã£o normal
  // ============================
  digitalWrite(ledAlerta, LOW);
  noTone(buzzer);

  // ============================
  // Controle manual
  // ============================
  if (Serial.available()) {

    char cmd = Serial.read();

    switch (cmd) {
      case 'q': posBase += 5; break;
      case 'a': posBase -= 5; break;
      case 'w': posOmbro += 5; break;
      case 's': posOmbro -= 5; break;
      case 'e': posCotovelo += 5; break;
      case 'd': posCotovelo -= 5; break;
      case 'r': posGarra += 5; break;
      case 'f': posGarra -= 5; break;

      case 't':
        digitalWrite(IN1, HIGH);
        digitalWrite(IN2, LOW);
        analogWrite(ENA, 200);
        break;

      case 'g':
        digitalWrite(IN1, LOW);
        digitalWrite(IN2, LOW);
        break;
    }

    posBase = constrain(posBase, 0, 180);
    posOmbro = constrain(posOmbro, 0, 180);
    posCotovelo = constrain(posCotovelo, 0, 180);
    posGarra = constrain(posGarra, 0, 180);

    servoBase.write(posBase);
    servoOmbro.write(posOmbro);
    servoCotovelo.write(posCotovelo);
    servoGarra.write(posGarra);
  }

  delay(100);
}
